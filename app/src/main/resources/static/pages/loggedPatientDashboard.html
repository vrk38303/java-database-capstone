<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/assets/images/logo/logo.png" />
    <title>Patient Dashboard - Smart Clinic</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; }
        .header { background: #015c5d; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        .header a { color: white; text-decoration: none; padding: 10px 20px; background: #A62B1F; border-radius: 5px; }
        .container { max-width: 1200px; margin: 30px auto; padding: 20px; }
        .dashboard-title { color: #003e3e; margin-bottom: 30px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; }
        .tab { padding: 15px 30px; background: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 16px; font-weight: bold; }
        .tab.active { background: #015c5d; color: white; }
        .card { background: white; border-radius: 10px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card h2 { color: #015c5d; margin-bottom: 20px; }
        .search-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-bar input, .search-bar select { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; flex: 1; min-width: 200px; }
        .btn { background: #015c5d; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #003e3e; }
        .doctor-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .doctor-card { background: #f9f9f9; padding: 20px; border-radius: 8px; border-left: 4px solid #015c5d; }
        .doctor-card h3 { color: #015c5d; margin-bottom: 10px; }
        .doctor-card p { color: #666; margin: 5px 0; }
        .book-btn { margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #015c5d; color: white; }
        tr:hover { background: #f5f5f5; }
        .status-pending { color: #f0ad4e; font-weight: bold; }
        .status-completed { color: #5cb85c; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Patient Dashboard - Smart Clinic</h1>
        <a href="/" onclick="localStorage.clear()">Logout</a>
    </div>
    
    <div class="container">
        <h1 class="dashboard-title">Welcome, Patient</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('search', this)">Find Doctors</button>
            <button class="tab" onclick="showTab('appointments', this)">My Appointments</button>
        </div>
        
        <div id="search-tab" class="tab-content active">
            <div class="card">
                <h2>Search for Doctors</h2>
                <div class="search-bar">
                    <input type="text" id="doctor-name" placeholder="Doctor name...">
                    <select id="specialty-filter">
                        <option value="">All Specialties</option>
                        <option value="General Medicine">General Medicine</option>
                        <option value="Cardiology">Cardiology</option>
                        <option value="Dermatology">Dermatology</option>
                        <option value="Orthopedics">Orthopedics</option>
                        <option value="Pediatrics">Pediatrics</option>
                        <option value="Neurology">Neurology</option>
                    </select>
                    <select id="time-filter">
                        <option value="">Any Time</option>
                        <option value="AM">Morning (AM)</option>
                        <option value="PM">Afternoon (PM)</option>
                    </select>
                    <button class="btn" onclick="searchDoctors()">Search</button>
                </div>
                <div id="doctor-results" class="doctor-grid"></div>
            </div>
        </div>
        
        <div id="appointments-tab" class="tab-content">
            <div class="card">
                <h2>My Appointments</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Doctor</th>
                            <th>Specialty</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointments-table">
                        <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="booking-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 999;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
            <h2 style="color: #015c5d; margin-bottom: 20px;">Book Appointment</h2>
            <form id="booking-form">
                <input type="hidden" id="booking-doctor-id">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Select Date</label>
                    <input type="date" id="booking-date" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Available Time Slots</label>
                    <select id="booking-time" required style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
                        <option value="">Select a date first</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Condition/Symptoms</label>
                    <textarea id="booking-condition" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
                </div>
                <button type="submit" class="btn">Book Appointment</button>
                <button type="button" class="btn" style="background: #ccc; color: #333;" onclick="closeBookingModal()">Cancel</button>
            </form>
        </div>
    </div>
    
    <script>
        const token = localStorage.getItem('token');
        
        if (!token) {
            window.location.href = '/';
        }
        
        function showTab(tabName, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'appointments') {
                loadAppointments();
            }
        }
        
        async function searchDoctors() {
            const name = document.getElementById('doctor-name').value || 'null';
            const time = document.getElementById('time-filter').value || 'null';
            const specialty = document.getElementById('specialty-filter').value || 'null';
            
            try {
                const response = await fetch(`/doctor/filter/${encodeURIComponent(name)}/${encodeURIComponent(time)}/${encodeURIComponent(specialty)}`);
                const data = await response.json();
                const container = document.getElementById('doctor-results');
                
                if (data.doctors && data.doctors.length > 0) {
                    container.innerHTML = data.doctors.map(doctor => `
                        <div class="doctor-card">
                            <h3>Dr. ${doctor.name}</h3>
                            <p><strong>Specialty:</strong> ${doctor.specialty}</p>
                            <p><strong>Email:</strong> ${doctor.email}</p>
                            <p><strong>Available:</strong> ${doctor.availableTimes ? doctor.availableTimes.join(', ') : 'Not set'}</p>
                            <button class="btn book-btn" onclick="openBookingModal(${doctor.id})">Book Appointment</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p>No doctors found matching your criteria.</p>';
                }
            } catch (error) {
                console.error('Error searching doctors:', error);
            }
        }
        
        async function loadAppointments() {
            try {
                const response = await fetch(`/appointment/patient/${token}`);
                const data = await response.json();
                const tbody = document.getElementById('appointments-table');
                
                if (data.appointments && data.appointments.length > 0) {
                    tbody.innerHTML = data.appointments.map(apt => `
                        <tr>
                            <td>Dr. ${apt.doctorName}</td>
                            <td>${apt.doctorSpecialty || ''}</td>
                            <td>${apt.appointmentDate}</td>
                            <td>${apt.appointmentTime}</td>
                            <td class="${apt.status === 0 ? 'status-pending' : 'status-completed'}">
                                ${apt.status === 0 ? 'Pending' : 'Completed'}
                            </td>
                            <td>
                                ${apt.status === 0 ? `<button class="btn" style="background: #A62B1F;" onclick="cancelAppointment(${apt.id})">Cancel</button>` : ''}
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No appointments found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading appointments:', error);
            }
        }
        
        function openBookingModal(doctorId) {
            document.getElementById('booking-doctor-id').value = doctorId;
            document.getElementById('booking-modal').classList.remove('hidden');
            document.getElementById('booking-modal').style.display = 'flex';
        }
        
        function closeBookingModal() {
            document.getElementById('booking-modal').classList.add('hidden');
            document.getElementById('booking-modal').style.display = 'none';
            document.getElementById('booking-form').reset();
        }
        
        document.getElementById('booking-date').addEventListener('change', async (e) => {
            const doctorId = document.getElementById('booking-doctor-id').value;
            const date = e.target.value;
            
            try {
                const response = await fetch(`/doctor/availability/patient/${doctorId}/${date}/${token}`);
                const data = await response.json();
                const select = document.getElementById('booking-time');
                
                if (data.availability && data.availability.length > 0) {
                    select.innerHTML = data.availability.map(time => `<option value="${time}">${time}</option>`).join('');
                } else {
                    select.innerHTML = '<option value="">No available slots</option>';
                }
            } catch (error) {
                console.error('Error loading availability:', error);
            }
        });
        
        document.getElementById('booking-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const doctorId = document.getElementById('booking-doctor-id').value;
            const date = document.getElementById('booking-date').value;
            const time = document.getElementById('booking-time').value;
            const condition = document.getElementById('booking-condition').value;
            
            const appointmentTime = `${date}T${time}:00`;
            
            try {
                const response = await fetch(`/appointment/${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        doctorId: parseInt(doctorId),
                        appointmentTime: appointmentTime,
                        condition: condition
                    })
                });
                
                if (response.ok) {
                    alert('Appointment booked successfully!');
                    closeBookingModal();
                    document.querySelectorAll('.tab')[1].click();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Error booking appointment');
                }
            } catch (error) {
                alert('Network error');
            }
        });
        
        async function cancelAppointment(id) {
            if (!confirm('Are you sure you want to cancel this appointment?')) return;
            
            try {
                const response = await fetch(`/appointment/${id}/${token}`, { method: 'DELETE' });
                if (response.ok) {
                    loadAppointments();
                }
            } catch (error) {
                console.error('Error cancelling appointment:', error);
            }
        }
        
        searchDoctors();
    </script>
</body>
</html>
